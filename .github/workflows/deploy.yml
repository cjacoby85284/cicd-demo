# ─────────────────────────────────────────────────────────────────────────────
# deploy.yml  —  CI/CD pipeline for cicd-demo
#
# PIPELINE OVERVIEW (in order):
#   1. Checkout your code onto a fresh GitHub-hosted Ubuntu VM
#   2. Apply any new Supabase SQL migrations to the DEV database
#   3. Record this deployment as a row in the `deployments` table
#   4. Install Wrangler and deploy the frontend to Cloudflare Pages
#
# SECRETS REQUIRED (set in GitHub repo → Settings → Secrets → Actions):
#   SUPABASE_ACCESS_TOKEN    — your Supabase personal access token
#   SUPABASE_DB_PASSWORD     — the DB password you set when creating the project
#   SUPABASE_SERVICE_ROLE_KEY — project service_role key (bypasses RLS for inserts)
#   CLOUDFLARE_API_TOKEN     — Cloudflare API token with Pages edit permission
#   CLOUDFLARE_ACCOUNT_ID    — your Cloudflare account ID
# ─────────────────────────────────────────────────────────────────────────────

name: Deploy to Cloudflare Pages (DEV)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      # ── STEP 1: Checkout ──────────────────────────────────────────────────
      # Clone your repo onto the VM so subsequent steps can see your files.
      - name: Checkout code
        uses: actions/checkout@v4

      # ── STEP 2: Apply Supabase Migrations ────────────────────────────────
      # The official Supabase action installs the CLI for us.
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # "supabase db push" compares the SQL files in supabase/migrations/ against
      # what's already been applied in the database, and runs anything new.
      # It's safe to run on every push — it's a no-op if nothing has changed.
      - name: Apply Supabase migrations
        run: supabase db push --project-ref ouuxueywkllggoyneiwm
        env:
          # The CLI uses these two env vars automatically — no flags needed.
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      # ── STEP 3: Log this deployment to Supabase ───────────────────────────
      # After migrations are applied, we insert a record for THIS deployment.
      # We use `jq` to safely build the JSON (handles special chars in commit
      # messages), then POST it to the Supabase REST API with the service role key.
      #
      # "github.sha"                    = the full git commit hash
      # "github.event.head_commit.message" = the commit message you typed
      # "github.ref_name"               = the branch name (e.g. "main")
      - name: Log deployment to Supabase
        run: |
          PAYLOAD=$(jq -n \
            --arg sha "$COMMIT_SHA" \
            --arg msg "$COMMIT_MSG" \
            --arg branch "$BRANCH" \
            '{commit_sha: $sha, commit_message: $msg, branch: $branch, status: "success"}')

          echo "Inserting deployment record..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            "https://ouuxueywkllggoyneiwm.supabase.co/rest/v1/deployments" \
            -H "apikey: ${SERVICE_KEY}" \
            -H "Authorization: Bearer ${SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "$PAYLOAD")
          echo "Supabase response: HTTP $HTTP_STATUS"
        env:
          SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          BRANCH: ${{ github.ref_name }}

      # ── STEP 4: Deploy Frontend to Cloudflare Pages ───────────────────────
      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Create Pages project (first time only)
        run: wrangler pages project create cicd-demo --production-branch=main || true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Cloudflare Pages
        run: wrangler pages deploy . --project-name=cicd-demo --branch=main --commit-dirty=true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
